<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard MYPE - Ecomypes</title>
    <link rel="stylesheet" href="dashboard_base.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .view { display: none; } .view.active { display: block; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .styled-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .styled-table th, .styled-table td { padding: 12px 15px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; }
        .styled-table th { background-color: #f4f7f6; font-weight: 600; }
        .styled-table tbody tr:hover { background-color: #f9f9f9; }
        .stock-low, .vencimiento-proximo { color: var(--color-bright-red); font-weight: 700; }
        .action-buttons button { background: none; border: none; cursor: pointer; font-size: 1.1rem; margin: 0 5px; color: #888; }
        .action-buttons button:hover { color: var(--color-dark-red); }
        .btn-sell { color: #28a745 !important; } .btn-sell:hover { color: #1f7a35 !important; }
        .dashboard-home-grid, .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        #ai-suggestions-card ul { list-style: none; padding-left: 0; } #ai-suggestions-card li { background-color: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--color-accent-orange); }
        .panel-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 998; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .panel-overlay.is-open { display: block; opacity: 1; }
        .slide-panel { position: fixed; top: 0; right: -500px; width: 480px; max-width: 90%; height: 100%; background-color: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 999; transition: right 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; }
        .slide-panel.is-open { right: 0; }
        .panel-header { padding: 20px 25px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; } .panel-header h2 { font-size: 1.4rem; color: var(--color-dark-red); } .panel-close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: #999; }
        .panel-content { padding: 25px; flex-grow: 1; overflow-y: auto; } .panel-content label { font-weight: 600; } .panel-content input { width: 100%; padding: 12px; margin-top: 8px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .panel-footer { padding: 20px 25px; border-top: 1px solid #eee; }
        .stat-card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-card { background: linear-gradient(135deg, var(--color-dark-red), var(--color-bright-red)); color: white; padding: 20px; border-radius: 12px; }
        .stat-card .stat-value { font-size: 2rem; font-weight: 700; } .stat-card .stat-label { font-size: 0.9rem; opacity: 0.8; }
        .supplier-card { background-color: #fff; border-radius: 12px; box-shadow: var(--shadow); padding: 20px; text-align: center; }
        .supplier-card .rating { color: var(--color-accent-orange); margin: 10px 0; } .supplier-card h3 { font-size: 1.2rem; margin-bottom: 5px; }
        .filter-group button { background-color: #eee; border: 1px solid #ddd; padding: 8px 15px; margin-right: 10px; border-radius: 20px; cursor: pointer; font-family: 'Poppins', sans-serif; }
        .filter-group button.active { background-color: var(--color-dark-red); color: white; border-color: var(--color-dark-red); }
    </style>
</head>
<body>
    <div class="panel-overlay" id="panel-overlay"></div>
    <div class="slide-panel" id="main-panel">
        <header class="panel-header"><h2 id="panel-title">Panel</h2><button class="panel-close-btn" id="panel-close-btn">&times;</button></header>
        <div class="panel-content" id="panel-content-area"></div>
        <footer class="panel-footer" id="panel-footer-area"></footer>
    </div>

    <div class="dashboard-grid">
        <aside class="sidebar">
            <div class="sidebar-header"><img src="logo.png" alt="Ecomypes Logo" class="logo"><h3>Bodega "Mi Bodeguita"</h3><p>ROSA - Breña</p></div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#inicio" class="nav-link active"><i class="fa-solid fa-house"></i><span>Inicio</span></a></li><li><a href="#inventario" class="nav-link"><i class="fa-solid fa-boxes-stacked"></i><span>Inventario</span></a></li><li><a href="#predicciones" class="nav-link"><i class="fa-solid fa-brain"></i><span>Predicciones IA</span></a></li><li><a href="#proveedores" class="nav-link"><i class="fa-solid fa-truck-fast"></i><span>Proveedores</span></a></li><li><a href="#pedidos" class="nav-link"><i class="fa-solid fa-receipt"></i><span>Mis Pedidos</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer"><nav class="sidebar-nav"><ul><li><a href="#" id="logout-btn"><i class="fa-solid fa-right-from-bracket"></i><span>Cerrar Sesión</span></a></li></ul></nav></div>
        </aside>

        <main class="main-content">
            <div id="inicio" class="view active"><header class="header"><h1>Hola de nuevo, Rosa! 👋</h1></header><div class="dashboard-home-grid"><div class="card"><div class="card-header"><h2>🔮 Predicción de Demanda Semanal</h2></div><canvas id="home-chart"></canvas></div><div class="card" id="ai-suggestions-card"><div class="card-header"><h2>💡 Análisis y Sugerencias de la IA</h2></div><ul id="ai-suggestions-list"></ul></div></div></div>
            <div id="inventario" class="view"><header class="header"><h1>Gestión de Inventario</h1><button class="btn btn-primary" id="add-product-btn"><i class="fa-solid fa-plus"></i> Añadir Producto</button></header><div class="card"><table class="styled-table"><thead><tr><th>Producto</th><th>Stock</th><th>Precio (S/)</th><th>Vencimiento</th><th>Acciones</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div>
            <div id="predicciones" class="view"><header class="header"><h1>🔮 Centro de Inteligencia Ecomypes</h1></header><div class="stat-card-grid"><div class="stat-card"><div class="stat-value">S/ 1,850</div><div class="stat-label">Ventas Proyectadas (7 días)</div></div><div class="stat-card"><div class="stat-value">Gaseosas</div><div class="stat-label">Categoría con Mayor Demanda</div></div><div class="stat-card"><div class="stat-value">Leche Gloria</div><div class="stat-label">⚠️ Riesgo de Quiebre de Stock</div></div></div><div class="card"><div class="card-header"><h2>Análisis de Demanda</h2><div class="filter-group" id="predictions-filter-group"><button class="active" data-timeframe="semanal">Semanal</button><button data-timeframe="mensual">Mensual</button><button data-timeframe="trimestral">Trimestral</button></div></div><canvas id="predictions-chart"></canvas></div></div>
            <div id="proveedores" class="view"><header class="header"><h1>Directorio de Proveedores</h1></header><div class="card"><input type="text" id="supplier-search-input" placeholder="🔎 Buscar proveedor por nombre o categoría..." style="width:100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd;"></div><div class="cards-grid" id="suppliers-grid"></div></div>
            <div id="pedidos" class="view"><header class="header"><h1>Historial de Mis Pedidos</h1></header></div>
        </main>
    </div>

    <div class="chatbot-fab"><i class="fa-solid fa-comment-dots"></i></div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // =======================================================
        // === 1. CONFIGURACIÓN INICIAL Y BASES DE DATOS SIMULADAS ===
        // =======================================================
        const navLinks = document.querySelectorAll('.nav-link');
        const views = document.querySelectorAll('.view');
        const logoutBtn = document.getElementById('logout-btn');
        const mainPanel = document.getElementById('main-panel');
        const panelOverlay = document.getElementById('panel-overlay');
        const closePanelBtn = document.getElementById('panel-close-btn');

        let inventoryData = [ { id: 1, name: "Gaseosa Inka Kola 1.5L", stock: 32, price: 7.50, expiry: "2025-12-31" }, { id: 2, name: "Leche Gloria Evaporada", stock: 12, price: 3.80, expiry: new Date(new Date().setDate(new Date().getDate() + 25)).toISOString().split('T')[0] }, { id: 3, name: "Galletas Casino Menta", stock: 56, price: 1.00, expiry: "2025-08-20" }, { id: 4, name: "Arroz Costeño 1kg", stock: 18, price: 4.50, expiry: "2026-05-01" }, ];
        const suppliersData = [ { id: 1, name: "Proveedor de Bebidas", category: "Bebidas y Licores", location: "San Miguel", rating: 5, recommended: true }, { id: 2, name: "Abarrotes del Centro", category: "Alimentos no perecibles", location: "La Victoria", rating: 4 }, { id: 3, name: "Distribuidora Lácteos del Sur", category: "Lácteos y Embutidos", location: "Surco", rating: 4 }, { id: 4, name: "Dulces y Golosinas SAC", category: "Golosinas y Snacks", location: "Lince", rating: 3 }, ];
        const catalogsData = { 1: [ { name: "Gaseosa Kola Real 3L", price: 6.50 }, { name: "Agua Cielo 2.5L", price: 2.80 }, { name: "Cerveza Pilsen 6-pack", price: 24.00 } ], 2: [ { name: "Arroz Costeño 5kg", price: 22.00 }, { name: "Aceite Primor 1L", price: 9.50 } ], 3: [ { name: "Queso Edam Bonlé", price: 15.00 }, { name: "Yogurt Gloria 1L", price: 7.00 } ], 4: [ { name: "Sublime Clásico", price: 1.50 }, { name: "Papas Lays Grandes", price: 5.00 } ] };

        const inventoryTableBody = document.getElementById('inventory-table-body');
        const panelTitle = document.getElementById('panel-title');
        const panelContent = document.getElementById('panel-content-area');
        const panelFooter = document.getElementById('panel-footer-area');
        let homeChartInstance, predictionsChartInstance;

        // =======================================================
        // === 2. FUNCIONES DE RENDERIZADO (DIBUJAR EN PANTALLA) ===
        // =======================================================
        function renderInventoryTable() {
            inventoryTableBody.innerHTML = '';
            inventoryData.forEach(item => {
                const isLowStock = item.stock <= 10 ? 'stock-low' : '';
                const expiryDate = new Date(item.expiry);
                const today = new Date();
                const daysUntilExpiry = Math.ceil((expiryDate - today) / (1000 * 3600 * 24));
                const isExpiringSoon = daysUntilExpiry < 30 ? 'vencimiento-proximo' : '';
                inventoryTableBody.innerHTML += `<tr data-id="${item.id}"><td>${item.name}</td><td class="${isLowStock}">${item.stock}</td><td>S/ ${item.price.toFixed(2)}</td><td class="${isExpiringSoon}">${new Date(item.expiry).toLocaleDateString()} (${daysUntilExpiry > 0 ? daysUntilExpiry + ' días' : 'Vencido'})</td><td class="action-buttons"><button class="btn-sell" title="Registrar Venta"><i class="fas fa-dollar-sign"></i></button><button class="edit-btn" title="Editar"><i class="fas fa-edit"></i></button><button class="delete-btn" title="Eliminar"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }
        
        function renderAIInsights() {
            const suggestionsList = document.getElementById('ai-suggestions-list');
            suggestionsList.innerHTML = ''; let insightsFound = 0;
            inventoryData.forEach(item => {
                if (item.stock <= 10) { insightsFound++; suggestionsList.innerHTML += `<li>📉 <strong>Stock Bajo:</strong> El inventario de <strong>${item.name}</strong> es de solo <strong>${item.stock}</strong> unidades. ¡Se recomienda reponer pronto!</li>`; }
                const daysUntilExpiry = Math.ceil((new Date(item.expiry) - new Date()) / (1000 * 3600 * 24));
                if (daysUntilExpiry < 30 && daysUntilExpiry > 0) { insightsFound++; suggestionsList.innerHTML += `<li>⏳ <strong>Alerta de Vencimiento:</strong> ¡<strong>${item.name}</strong> vence en <strong>${daysUntilExpiry} días</strong>! 💡 Crea una oferta para acelerar su venta.</li>`; }
            });
            if (insightsFound === 0) { suggestionsList.innerHTML = `<li>✅ ¡Todo en orden! Tu inventario se ve saludable. Buen trabajo.</li>`; }
        }

        function renderHomeChart() {
            const ctx = document.getElementById('home-chart').getContext('2d');
            if (homeChartInstance) { homeChartInstance.destroy(); }
            const randomData = Array.from({length: 7}, () => Math.floor(Math.random() * (300 - 50 + 1)) + 50);
            homeChartInstance = new Chart(ctx, { type: 'line', data: { labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom(P)'], datasets: [{ label: 'Ventas y Predicción (S/)', data: randomData, borderColor: 'var(--color-bright-red)', tension: 0.4, fill: true, backgroundColor: 'rgba(206, 17, 38, 0.1)' }] }, options: { animation: { duration: 1000 } } });
        }
        
        function renderSuppliersView(suppliers = suppliersData) {
            const suppliersGrid = document.getElementById('suppliers-grid');
            suppliersGrid.innerHTML = '';
            suppliers.forEach(supplier => {
                const ratingStars = '⭐️'.repeat(supplier.rating) + '☆'.repeat(5 - supplier.rating);
                const recommendedBadge = supplier.recommended ? `<span class="status-chip status-entregado" style="font-size:0.7em;">Recomendado por IA</span>` : '';
                suppliersGrid.innerHTML += `<div class="supplier-card"><div style="height:20px;">${recommendedBadge}</div><h3>${supplier.name}</h3><p style="color:#666;">${supplier.category}</p><div class="rating">${ratingStars}</div><button class="btn btn-secondary view-catalog-btn" data-supplier-id="${supplier.id}">Ver Catálogo</button></div>`;
            });
        }
        
        function renderPredictionsChart(timeframe = 'semanal') {
            const ctx = document.getElementById('predictions-chart')?.getContext('2d');
            if (!ctx) return;
            if (predictionsChartInstance) { predictionsChartInstance.destroy(); }
            let labels, historicData, predictedData;
            switch(timeframe) {
                case 'mensual': labels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4 (Pred)']; historicData = [4500, 5100, 4800, 0]; predictedData = [4500, 5100, 4800, 5500]; break;
                case 'trimestral': labels = ['Mes 1', 'Mes 2', 'Mes 3 (Pred)']; historicData = [20000, 22000, 0]; predictedData = [20000, 22000, 25000]; break;
                default: labels = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom (Pred)']; historicData = [220, 190, 250, 210, 300, 320, 0]; predictedData = [220, 190, 250, 210, 300, 320, 350];
            }
            predictionsChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Ventas Históricas (S/)', data: historicData, backgroundColor: 'rgba(255, 167, 64, 0.6)' }, { type: 'line', label: 'Predicción IA (S/)', data: predictedData, borderColor: 'var(--color-bright-red)', tension: 0.4, fill: false, order: -1 }] } });
        }

        // =======================================================
        // === 3. LÓGICA DEL PANEL LATERAL Y FORMULARIOS         ===
        // =======================================================
        function openPanel() { panelOverlay.classList.add('is-open'); mainPanel.classList.add('is-open'); }
        function closePanel() { panelOverlay.classList.remove('is-open'); mainPanel.classList.remove('is-open'); }
        
        function showProductForm(item = null) {
            panelTitle.textContent = item ? "Editar Producto" : "Añadir Nuevo Producto";
            panelContent.innerHTML = `<form id="product-form"><input type="hidden" id="product-id" value="${item ? item.id : ''}"><div><label for="product-name">Nombre</label><input type="text" id="product-name" value="${item ? item.name : ''}" required></div><div><label for="product-stock">Stock</label><input type="number" id="product-stock" value="${item ? item.stock : ''}" required></div><div><label for="product-price">Precio (S/)</label><input type="number" step="0.01" id="product-price" value="${item ? item.price : ''}" required></div><div><label for="product-expiry">Vencimiento</label><input type="date" id="product-expiry" value="${item ? item.expiry : ''}" required></div></form>`;
            panelFooter.innerHTML = `<button type="submit" form="product-form" class="btn btn-primary" style="width:100%;">Guardar Cambios</button>`;
            document.getElementById('product-form').addEventListener('submit', handleProductFormSubmit);
            openPanel();
        }

        function showSupplierCatalog(supplierId) {
            const supplier = suppliersData.find(s => s.id == supplierId);
            const catalog = catalogsData[supplierId] || [];
            panelTitle.textContent = `Catálogo de ${supplier.name}`;
            panelContent.innerHTML = `<ul>${catalog.map(item => `<li style="padding: 8px 0;">${item.name} - <strong>S/ ${item.price.toFixed(2)}</strong></li>`).join('')}</ul>`;
            panelFooter.innerHTML = `<button id="simulated-order-btn" class="btn btn-primary" style="width:100%;">Simular Pedido a este Proveedor</button>`;
            document.getElementById('simulated-order-btn').addEventListener('click', () => { alert(`✅ Pedido simulado a ${supplier.name} enviado!`); closePanel(); });
            openPanel();
        }

        function handleProductFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('product-id').value;
            const updatedProduct = { name: document.getElementById('product-name').value, stock: parseInt(document.getElementById('product-stock').value), price: parseFloat(document.getElementById('product-price').value), expiry: document.getElementById('product-expiry').value };
            if (id) { const index = inventoryData.findIndex(item => item.id == id); inventoryData[index] = { id: parseInt(id), ...updatedProduct }; } else { updatedProduct.id = Date.now(); inventoryData.push(updatedProduct); }
            closePanel();
            setTimeout(updateAllUI, 400);
        }

        // =======================================================
        // === 4. MANEJADORES DE EVENTOS (EVENT LISTENERS)      ===
        // =======================================================
        logoutBtn.addEventListener('click', e => { e.preventDefault(); window.location.href = 'index.html'; });
        closePanelBtn.addEventListener('click', closePanel);
        panelOverlay.addEventListener('click', closePanel);
        document.getElementById('add-product-btn').addEventListener('click', () => showProductForm());

        inventoryTableBody.addEventListener('click', function(e) {
            const button = e.target.closest('button');
            if (!button) return;
            const id = button.closest('tr').dataset.id;
            if (button.classList.contains('edit-btn')) { showProductForm(inventoryData.find(p => p.id == id)); }
            if (button.classList.contains('delete-btn')) { if (confirm('¿Seguro?')) { inventoryData = inventoryData.filter(p => p.id != id); updateAllUI(); } }
            if (button.classList.contains('btn-sell')) {
                const itemIndex = inventoryData.findIndex(p => p.id == id);
                const quantitySold = parseInt(prompt(`🛒 Venta de "${inventoryData[itemIndex].name}".\n\n¿Qué cantidad se vendió?`, "1"));
                if (!isNaN(quantitySold) && quantitySold > 0) { if (inventoryData[itemIndex].stock >= quantitySold) { inventoryData[itemIndex].stock -= quantitySold; updateAllUI(); } else { alert("❌ Error: No hay stock suficiente."); } }
            }
        });

        document.getElementById('supplier-search-input').addEventListener('keyup', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            renderSuppliersView(suppliersData.filter(s => s.name.toLowerCase().includes(searchTerm) || s.category.toLowerCase().includes(searchTerm)));
        });

        document.getElementById('suppliers-grid').addEventListener('click', function(e) {
            const button = e.target.closest('.view-catalog-btn');
            if (button) { showSupplierCatalog(button.dataset.supplierId); }
        });
        
        document.getElementById('predictions-filter-group').addEventListener('click', function(e){
            const button = e.target.closest('button');
            if(button && !button.classList.contains('active')){
                this.querySelector('.active').classList.remove('active');
                button.classList.add('active');
                renderPredictionsChart(button.dataset.timeframe);
            }
        });

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if(this.classList.contains('active')) return;
                navLinks.forEach(l => l.classList.remove('active'));
                views.forEach(v => v.classList.remove('active'));
                this.classList.add('active');
                const targetViewId = this.getAttribute('href');
                document.querySelector(targetViewId).classList.add('active');
                
                if (targetViewId === '#predicciones') { renderPredictionsChart(); }
                if (targetViewId === '#proveedores') { renderSuppliersView(); }
            });
        });

        // =======================================================
        // === 5. INICIALIZACIÓN Y FUNCIÓN DE ACTUALIZACIÓN TOTAL ===
        // =======================================================
        function updateAllUI() {
            renderInventoryTable();
            renderAIInsights();
            renderHomeChart();
        }

        updateAllUI(); // Carga inicial de la UI
    });
    </script>
</body>
</html>